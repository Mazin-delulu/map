<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B·∫£n ƒë·ªì nghi√™n c·ª©u sinh v·∫≠t bi·ªÉn</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* Sidebar (PC) */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 300px;
      height: 100%;
      background: #f8f9fa;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding: 15px;
      box-sizing: border-box;
      transform: translateX(0);
      transition: transform 0.3s ease;
      z-index: 1002;
    }

    #sidebar.collapsed {
      transform: translateX(-100%);
    }

    /* N√∫t toggle */
    #toggleSidebar {
      position: fixed;
      top: 20px;
      left: 10px;
      background: #0d6efd;
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1100;
      user-select: none;
    }

    #toggleSidebar:hover {
      background: #0b5ed7;
    }

    h2 {
      font-size: 18px;
      margin-top: 0;
      color: #333;
      text-align: center;
    }

    .region-item {
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }

    label {
      cursor: pointer;
      font-size: 14px;
      color: #333;
    }

    .popup-title {
      font-weight: bold;
      font-size: 14px;
      color: #1a237e;
    }

    /* ==== File group ==== */
    .file-group { position: relative; margin-bottom: 6px; }
    .file-group-title {
      background: #eef3ff;
      color: #0d6efd;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-block;
      transition: background 0.2s;
    }
    .file-group-title:hover { background: #dbe7ff; }

    /* Popup ph·ª• */
    #subPopup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 340px;
      max-height: 300px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      padding: 10px;
      display: none;
      z-index: 99999;
    }

    .leaflet-control-zoom {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      z-index: 1200 !important;
    }

    /* üì± Mobile optimization */
    @media (max-width: 768px) {
      body, html { overflow: auto; }

      #sidebar {
        position: relative !important;
        width: 100% !important;
        height: auto !important;
        max-height: 35vh !important;
        transform: none !important;
        border-right: none;
        border-bottom: 1px solid #ccc;
        box-shadow: none;
        z-index: 5;
      }

      #toggleSidebar { display: none !important; }

      #map {
        position: relative !important;
        width: 100% !important;
        height: 65vh !important;
      }

      #subPopup {
        left: 50% !important;
        bottom: 5% !important;
        transform: translateX(-50%) !important;
        width: 90% !important;
        max-height: 60vh !important;
        border-radius: 16px !important;
      }

      #closeSubPopup {
        display: inline-block;
        float: right;
        font-size: 22px;
        color: #444;
        cursor: pointer;
      }
    }
  </style>
</head>
<body>
  <div id="sidebar" class="collapsed">
    <h2>V√πng nghi√™n c·ª©u</h2>
    <div id="regionList"></div>
  </div>

  <div id="toggleSidebar">‚Ä∫</div>
  <div id="map"></div>

  <script>
  const map = L.map("map").setView([16.0471, 108.2068], 6);
  map.zoomControl.setPosition('topright');

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
  }).addTo(map);

  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("toggleSidebar");

  toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
    const isCollapsed = sidebar.classList.contains("collapsed");
    toggleBtn.innerHTML = isCollapsed ? "‚Ä∫" : "‚Äπ";
    toggleBtn.style.left = isCollapsed ? "10px" : "280px";
    map.invalidateSize({ pan: false });
  });

  function createSVGIcon(color = "#0d6efd") {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
        fill="${color}" width="32" height="32">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13
        c0-3.87-3.13-7-7-7zm0 9.5c-1.38
        0-2.5-1.12-2.5-2.5s1.12-2.5
        2.5-2.5 2.5 1.12 2.5 2.5
        -1.12 2.5-2.5 2.5z"/>
      </svg>`;
    return L.divIcon({
      html: svg,
      className: "custom-marker",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });
  }

  const regionMarkers = {};
  const mainMarkers = {};

  const popupOverlay = document.createElement("div");
  popupOverlay.id = "subPopup";
  document.body.appendChild(popupOverlay);

  function getFileIcon(ext) {
    ext = ext.toLowerCase();
    if (["doc", "docx"].includes(ext)) return "üìÑ";
    if (["xls", "xlsx", "csv"].includes(ext)) return "üìä";
    if (["ppt", "pptx"].includes(ext)) return "üìà";
    if (["pdf"].includes(ext)) return "üìï";
    if (["zip", "rar", "7z"].includes(ext)) return "üóúÔ∏è";
    if (["jpg", "jpeg", "png", "gif", "svg"].includes(ext)) return "üñºÔ∏è";
    if (["txt"].includes(ext)) return "üìù";
    if (["mp4", "avi", "mov", "mkv"].includes(ext)) return "üéûÔ∏è";
    return "üìÅ";
  }

  function showSubPopup(regionName, title, filesHTML) {
    popupOverlay.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <strong style="font-size:14px">${regionName} ‚Äî ${title}</strong>
        <span id="closeSubPopup">&times;</span>
      </div>
      <div style="max-height:220px;overflow-y:auto;padding-right:6px;">
        ${filesHTML}
      </div>
    `;
    popupOverlay.style.display = "block";
    document.body.classList.add("popup-open");
    document.getElementById("closeSubPopup").onclick = () => {
      popupOverlay.style.display = "none";
      document.body.classList.remove("popup-open");
    };
  }

  fetch("./data_nghiencuu.json")
    .then(res => res.json())
    .then(data => {
      const regionList = document.getElementById("regionList");

      data.forEach(region => {
        const { region: name, year, links, representative, points } = region;
        const color = "#" + Math.floor(Math.random() * 16777215).toString(16);

        const centerMarker = L.marker([representative.lat, representative.lon], {
          icon: createSVGIcon(color)
        }).addTo(map);
        mainMarkers[name] = centerMarker;

        let linksHTML = "<div><em>Ch∆∞a c√≥ link t√†i li·ªáu</em></div>";
        if (links && Array.isArray(links) && links.length > 0) {
          linksHTML = links.map((group, gi) => `
            <div class="file-group" data-group-index="${gi}">
              <div class="file-group-title">üìò ${group.group_name}</div>
            </div>
          `).join("");
        }

        const popupHTML = `
          <div>
            <div class="popup-title" style="color:${color}">${name}</div>
            <div>NƒÉm: ${year ?? "Kh√¥ng r√µ"}</div>
            ${linksHTML}
          </div>
        `;

        centerMarker.bindPopup(popupHTML);

        // ‚úÖ fix icon & click
        centerMarker.on("popupopen", e => {
          const popupEl = e.popup.getElement();
          setTimeout(() => {
            popupEl.querySelectorAll(".file-group").forEach(groupEl => {
              groupEl.addEventListener("click", () => {
                const idx = Number(groupEl.dataset.groupIndex);
                const group = links[idx];
                if (!group || !group.files) return;

                const filesHTML = group.files.map(f => {
                  const ext = (f.name || "").split('.').pop();
                  return `
                    <div style="margin:6px 0;">
                      <a href="${f.url}" target="_blank" style="color:#0d6efd;text-decoration:none;">
                        ${getFileIcon(ext)} ${f.name}
                      </a>
                    </div>
                  `;
                }).join("");

                showSubPopup(name, group.group_name, filesHTML);
              });
            });
          }, 80);
        });

        const markers = (points || []).map(p =>
          L.circleMarker([p.lat, p.lon], {
            radius: 5,
            color,
            fillColor: color,
            fillOpacity: 0.85,
            weight: 1
          }).bindPopup(`<b>${p.name}</b>`)
        );
        regionMarkers[name] = markers;

        const div = document.createElement("div");
        div.className = "region-item";
        div.innerHTML = `
          <label>
            <input type="checkbox" data-region="${name}">
            <strong style="color:${color}">${name}</strong> (${year ?? "N/A"})
          </label>`;
        regionList.appendChild(div);
      });

      // Ch·ªâ t·∫Øt popup t√†i li·ªáu n·∫øu ƒë√∫ng v√πng ƒë√≥
      regionList.addEventListener("change", e => {
        const name = e.target.dataset.region;
        const markers = regionMarkers[name] || [];
        const mainMarker = mainMarkers[name];

        if (e.target.checked) {
          markers.forEach(m => m.addTo(map));
          if (mainMarker) {
            mainMarker.openPopup();
            map.setView(mainMarker.getLatLng(), 7);
          }
        } else {
          markers.forEach(m => map.removeLayer(m));
          if (mainMarker) mainMarker.closePopup();

          const popupTitle = popupOverlay.querySelector("strong");
          if (
            popupOverlay.style.display === "block" &&
            popupTitle &&
            popupTitle.textContent.startsWith(name)
          ) {
            popupOverlay.style.display = "none";
            document.body.classList.remove("popup-open");
          }
        }
      });
    })
    .catch(err => console.error("L·ªói khi t·∫£i JSON:", err));

  setTimeout(() => map.invalidateSize(), 800);
  </script>
</body>
</html>
